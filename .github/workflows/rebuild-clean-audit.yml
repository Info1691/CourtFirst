name: Rebuild + Clean + Audit Cases

on:
  workflow_dispatch:
    inputs:
      ltj_lines_path:
        description: "Path to LTJ lines JSON (default: LTJ-ui/out/LTJ.lines.json)"
        required: false
        default: "LTJ-ui/out/LTJ.lines.json"
      start_line:
        description: "Start line number (inclusive)"
        required: true
        default: "1276"
      end_line:
        description: "End line number (inclusive)"
        required: true
        default: "3083"

jobs:
  rebuild_clean_audit:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Check out CourtFirst
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📥 Check out LTJ-ui (private)
        uses: actions/checkout@v4
        with:
          repository: Info1691/LTJ-ui
          path: LTJ-ui
          token: ${{ secrets.LTJ_UI_TOKEN }}

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"

      - name: 🧱 Rebuild cases from LTJ lines
        run: |
          python tools/rebuild_cases_from_ltj_lines.py \
            --ltj-lines "${{ github.event.inputs.ltj_lines_path }}" \
            --start ${{ github.event.inputs.start_line }} \
            --end ${{ github.event.inputs.end_line }} \
            --out data/cases_from_ltj.csv

      - name: ✂️ Clean titles (safe, no data loss)
        run: |
          python tools/clean_cases_safe.py

      - name: 📊 Audit counts across pipeline
        run: |
          python tools/audit_counts.py

      - name: 📤 Upload artifacts (CSV + reports)
        uses: actions/upload-artifact@v4
        with:
          name: case-rebuild-results
          path: |
            data/cases_from_ltj.csv
            data/cases_clean.csv
            out/rebuild_report.json
            out/clean_report.json
            out/audit_report.json
            out/audit_missing.csv
